<?xml version="1.0"?>
<openerp>
    <data>

    <report
        id="partner_open_invoices"
        model="res.partner"
        string="Open invoices"
        report_type="qweb-pdf"
        name="partner_report_open_invoices.report_partner_open_invoices"
        file="partner_report_open_invoices.report_partner_open_invoices"
    />

    <template id="report_partner_open_invoices">
        <t t-call="report.html_container">
            <t t-foreach="docs" t-as="partner">
                <t t-call="partner_report_open_invoices.report_partner_open_invoices_document" t-lang="partner.lang"/>
            </t>
        </t>
    </template>

    <template id="report_partner_open_invoices_document">
        <t t-call="report.external_layout">
            <div class="page">
                <div class="oe_structure"/>
                <h1>Open invoices</h1>

                <div class="row">
                    <div class="col-xs-6">
                        <div class="col-xs-6">
                            <span>Customer:</span>
                        </div>
                        <div class="col-xs-6">
                            <span t-field="partner.name" />
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-6">
                        <div class="col-xs-6">
                            <span>Date:</span>
                        </div>
                        <div class="col-xs-6">
                            <span t-esc="context_timestamp(datetime.datetime.now()).strftime('%d.%m.%Y')"/>
                        </div>
                    </div>
                </div>

                <t t-set="invoices" t-value="partner.invoice_ids.filtered(lambda i: i.state == 'open')" />
                <t t-set="total_amount" t-value="0.00" />
                <t t-set="total_residual" t-value="0.00" />

                <table t-if="invoices" class="table table-condensed mt32">
                    <thead>
                        <tr>
                            <th>Invoice number</th>
                            <th>Source document</th>
                            <th>Due date</th>
                            <th class="text-right">Amount</th>
                            <th class="text-right">Amount due</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr t-foreach="invoices" t-as="invoice">
                            <t t-set="multiplier" t-value="-1 if invoice.type=='out_refund' else 1" />
                            <t t-set="total_amount" t-value="total_amount + invoice.amount_total * multiplier" />
                            <t t-set="total_residual" t-value="total_residual + invoice.residual * multiplier" />

                            <td><span t-field="invoice.number" /></td>
                            <td><span t-field="invoice.origin" /></td>
                            <td><span t-field="invoice.date_due" /></td>
                            <td class="text-right"><span t-if="multiplier==-1">-</span><span t-field="invoice.amount_total" /></td>
                            <td class="text-right"><span t-if="multiplier==-1">-</span><span t-field="invoice.residual" /></td>
                        </tr>
                        <tr>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th class="text-right"><span t-esc="'%.2f'% total_amount" /></th>
                            <th class="text-right"><span t-esc="'%.2f'% total_residual" /></th>
                        </tr>
                    </tbody>
                </table>
                <div class="mt32" t-if="not invoices">
                    <p>This customer has no open invoices</p>
                </div>

                <!-- Page break -->
                <p style="page-break-before:always;"> </p>
            </div>
        </t>
    </template>

    </data>
</openerp>
